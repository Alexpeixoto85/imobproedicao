<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ImobiPro - Gest√£o Elite</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #64748b;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --dark: #0f172a; --light: #f8fafc; --surface: #ffffff; --border: #e2e8f0;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top)); --nav-height: calc(65px + var(--safe-bottom));
            --radius-md: 12px; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: var(--dark); height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }

        header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); padding: var(--safe-top) 16px 10px; height: var(--header-height); display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; width: 100%; z-index: 50; border-bottom: 1px solid var(--border); }
        .brand { font-size: 1.25rem; font-weight: 800; color: var(--dark); }
        .brand span { color: var(--primary); }

        main { flex: 1; overflow-y: auto; padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 20px); }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); padding: 16px; border-radius: var(--radius-md); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--dark); margin: 4px 0; }
        .stat-label { font-size: 0.75rem; color: var(--secondary); text-transform: uppercase; font-weight: 600; }
        .bg-blue { background: #dbeafe; color: var(--primary); } .bg-green { background: #d1fae5; color: var(--success); }

        /* Property/Client Cards */
        .card { background: var(--surface); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); position: relative; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: var(--success); color: white; }
        .badge-primary { background: var(--primary); color: white; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; }
        .btn-block { width: 100%; padding: 14px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: 700; cursor: pointer; margin-top: 10px; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom); z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--secondary); text-decoration: none; font-size: 0.65rem; font-weight: 600; gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; }

        /* Funnel */
        .funnel-stage { background: white; border-left: 4px solid var(--primary); padding: 12px; margin-bottom: 8px; border-radius: 0 8px 8px 0; cursor: pointer; }
        .funnel-stage-header { display: flex; justify-content: space-between; align-items: center; }
        .client-item { padding: 8px; background: #f8fafc; border-radius: 4px; margin-top: 8px; font-size: 0.9rem; display: flex; justify-content: space-between; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        .modal-sheet { width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; }

        .loading-screen { position: fixed; inset: 0; background: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <h2>ImobiPro</h2>
    </div>

    <header>
        <div class="brand"><span>Imobi</span>Pro</div>
        <button onclick="UI.openModal('settings')" style="background:none; border:none; font-size: 1.2rem;"><i class="fas fa-cog"></i></button>
    </header>

    <main>
        <div id="view-home" class="view active">
            <h3 style="margin-bottom: 16px;">Resumo Financeiro</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Vendas M√™s (Real)</div>
                    <div class="stat-value" id="dash-vendas-real">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Comiss√µes a Receber</div>
                    <div class="stat-value" id="dash-comissao" style="color: var(--success);">R$ 0,00</div>
                </div>
                <div class="stat-card" onclick="UI.switchView('view-imoveis')">
                    <div class="stat-label">Im√≥veis Ativos</div>
                    <div class="stat-value" id="dash-imoveis">0</div>
                </div>
                <div class="stat-card" onclick="UI.switchView('view-clientes')">
                    <div class="stat-label">Leads Ativos</div>
                    <div class="stat-value" id="dash-clientes">0</div>
                </div>
            </div>
            
            <h3>Pr√≥ximos Compromissos</h3>
            <div id="list-agenda-home" style="margin-top: 12px;"></div>
        </div>

        <div id="view-imoveis" class="view">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                <h3>Cat√°logo de Im√≥veis</h3>
                <button onclick="UI.openModal('imovel')" class="badge badge-primary">+ Novo</button>
            </div>
            <input type="text" class="form-control" placeholder="Buscar im√≥vel..." oninput="UI.renderImoveis(this.value)" style="margin-bottom:15px;">
            <div id="list-imoveis"></div>
        </div>

        <div id="view-clientes" class="view">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                <h3>Gest√£o de Clientes</h3>
                <button onclick="UI.openModal('cliente')" class="badge badge-primary">+ Novo</button>
            </div>
            <div id="list-clientes"></div>
        </div>

        <div id="view-funil" class="view">
            <h3 style="margin-bottom:15px;">Funil de Vendas</h3>
            <div id="funnel-container"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="javascript:void(0)" class="nav-item active" onclick="UI.switchView('view-home', this)"><i class="fas fa-chart-pie"></i>In√≠cio</a>
        <a href="javascript:void(0)" class="nav-item" onclick="UI.switchView('view-imoveis', this)"><i class="fas fa-building"></i>Im√≥veis</a>
        <a href="javascript:void(0)" class="nav-item" onclick="UI.switchView('view-clientes', this)"><i class="fas fa-users"></i>Clientes</a>
        <a href="javascript:void(0)" class="nav-item" onclick="UI.switchView('view-funil', this)"><i class="fas fa-filter"></i>Funil</a>
    </nav>

    <div class="modal-overlay" id="modal-venda-concluida">
        <div class="modal-sheet">
            <h3 style="color: var(--success); margin-bottom: 10px;">üèÜ Confirmar Venda</h3>
            <p style="font-size: 0.85rem; color: var(--secondary); margin-bottom: 15px;">Parab√©ns! Informe os detalhes reais da negocia√ß√£o abaixo:</p>
            
            <form id="form-venda-final">
                <input type="hidden" id="venda-cliente-id">
                <div class="form-group">
                    <label class="form-label">Valor Real da Venda (Fechamento)</label>
                    <input type="text" id="venda-valor-real" class="form-control" placeholder="R$ 0,00" oninput="Utils.maskMoney(this)" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data do Fechamento</label>
                    <input type="date" id="venda-data" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Comiss√£o Combinada (%)</label>
                    <input type="number" id="venda-comissao-p" class="form-control" value="5" step="0.1">
                </div>
                <button type="submit" class="btn-block" style="background: var(--success);">Finalizar e Arquivar</button>
                <button type="button" class="btn-block" style="background: #eee; color: #333;" onclick="UI.closeModals()">Cancelar</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-imovel">
        <div class="modal-sheet">
            <h3 id="imovel-modal-title">Novo Im√≥vel</h3>
            <form id="form-imovel" style="margin-top:15px;">
                <input type="hidden" id="i-id">
                <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" id="i-titulo" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Valor de Tabela (R$)</label><input type="text" id="i-valor" class="form-control" oninput="Utils.maskMoney(this)" required></div>
                <div class="form-group"><label class="form-label">Endere√ßo/Unidade</label><input type="text" id="i-endereco" class="form-control" required></div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="i-status" class="form-control">
                        <option value="disponivel">Dispon√≠vel</option>
                        <option value="vendido">Vendido</option>
                    </select>
                </div>
                <button type="submit" class="btn-block">Salvar Im√≥vel</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-cliente">
        <div class="modal-sheet">
            <h3>Ficha do Cliente</h3>
            <form id="form-cliente" style="margin-top:15px;">
                <input type="hidden" id="c-id">
                <div class="form-group"><label class="form-label">Nome Completo</label><input type="text" id="c-nome" class="form-control" required></div>
                <div class="form-group"><label class="form-label">WhatsApp</label><input type="tel" id="c-tel" class="form-control" placeholder="(00) 00000-0000" oninput="Utils.maskPhone(this)"></div>
                <div class="form-group">
                    <label class="form-label">Im√≥vel de Interesse</label>
                    <select id="c-imovel" class="form-control" required></select>
                </div>
                <button type="submit" class="btn-block">Salvar Cliente</button>
            </form>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS (INDEXED DB) ---
        const DB = {
            dbName: "ImobiProV3",
            version: 1,
            instance: null,
            init() {
                return new Promise((resolve) => {
                    const req = indexedDB.open(this.dbName, this.version);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        db.createObjectStore("imoveis", { keyPath: "id" });
                        db.createObjectStore("clientes", { keyPath: "id" });
                        db.createObjectStore("config", { keyPath: "id" });
                    };
                    req.onsuccess = (e) => { this.instance = e.target.result; resolve(); };
                });
            },
            async getAll(store) {
                return new Promise(res => {
                    const tx = this.instance.transaction(store, "readonly");
                    tx.objectStore(store).getAll().onsuccess = (e) => res(e.target.result);
                });
            },
            async save(store, data) {
                const tx = this.instance.transaction(store, "readwrite");
                tx.objectStore(store).put(data);
                return new Promise(res => tx.oncomplete = res);
            }
        };

        // --- UTILIT√ÅRIOS ---
        const Utils = {
            id: () => "_" + Math.random().toString(36).substr(2, 9),
            maskMoney: (i) => {
                let v = i.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2).replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                i.value = "R$ " + v;
            },
            maskPhone: (i) => {
                let v = i.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                i.value = v;
            },
            parseMoney: (v) => Number(v.replace(/[^\d,]/g, '').replace(',', '.')) || 0,
            formatMoney: (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
        };

        // --- L√ìGICA DO SISTEMA ---
        const Core = {
            data: { imoveis: [], clientes: [] },
            async load() {
                this.data.imoveis = await DB.getAll("imoveis");
                this.data.clientes = await DB.getAll("clientes");
                UI.renderAll();
            }
        };

        // --- INTERFACE (UI) ---
        const UI = {
            switchView(viewId, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if(el) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }
            },
            openModal(id) { document.getElementById('modal-' + id).classList.add('active'); },
            closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); },
            
            renderAll() {
                this.renderImoveis();
                this.renderClientes();
                this.renderFunil();
                this.renderDash();
                this.updateSelects();
            },

            renderDash() {
                const vendas = Core.data.clientes.filter(c => c.etapa === 'venda');
                const totalReal = vendas.reduce((sum, c) => sum + (c.valorVendaReal || 0), 0);
                const totalComissao = vendas.reduce((sum, c) => sum + (c.comissaoValor || 0), 0);
                
                document.getElementById('dash-vendas-real').innerText = Utils.formatMoney(totalReal);
                document.getElementById('dash-comissao').innerText = Utils.formatMoney(totalComissao);
                document.getElementById('dash-imoveis').innerText = Core.data.imoveis.filter(i => i.status === 'disponivel').length;
                document.getElementById('dash-clientes').innerText = Core.data.clientes.filter(c => c.etapa !== 'venda').length;
            },

            renderImoveis(filter = "") {
                const list = document.getElementById('list-imoveis');
                list.innerHTML = "";
                Core.data.imoveis.filter(i => i.titulo.toLowerCase().includes(filter.toLowerCase())).forEach(i => {
                    list.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${i.titulo}</strong>
                                <span class="badge ${i.status === 'vendido' ? 'badge-success' : 'badge-primary'}">${i.status}</span>
                            </div>
                            <div style="font-size:0.85rem; color:var(--secondary); margin: 5px 0;">${i.endereco}</div>
                            <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">${Utils.formatMoney(i.valor)}</div>
                        </div>
                    `;
                });
            },

            renderClientes() {
                const list = document.getElementById('list-clientes');
                list.innerHTML = "";
                Core.data.clientes.forEach(c => {
                    const imovel = Core.data.imoveis.find(i => i.id === c.imovelId);
                    list.innerHTML += `
                        <div class="card">
                            <div style="font-weight:700;">${c.nome}</div>
                            <div style="font-size:0.8rem; color:var(--secondary);">Interesse: ${imovel ? imovel.titulo : 'N√£o definido'}</div>
                            <div style="margin-top:10px;">
                                <button class="badge badge-primary" onclick="UI.preparaVenda('${c.id}')">Fechar Venda</button>
                            </div>
                        </div>
                    `;
                });
            },

            updateSelects() {
                const sel = document.getElementById('c-imovel');
                sel.innerHTML = '<option value="">Selecione um im√≥vel...</option>';
                Core.data.imoveis.filter(i => i.status === 'disponivel').forEach(i => {
                    sel.innerHTML += `<option value="${i.id}">${i.titulo} (${Utils.formatMoney(i.valor)})</option>`;
                });
            },

            renderFunil() {
                const container = document.getElementById('funnel-container');
                const etapas = [
                    { id: 'lead', nome: 'Lead Novo' },
                    { id: 'visita', nome: 'Visita Agendada' },
                    { id: 'proposta', nome: 'Proposta Enviada' },
                    { id: 'venda', nome: 'Venda Conclu√≠da' }
                ];
                
                container.innerHTML = etapas.map(e => {
                    const cls = Core.data.clientes.filter(c => c.etapa === e.id);
                    return `
                        <div class="funnel-stage">
                            <div class="funnel-stage-header">
                                <strong>${e.nome}</strong>
                                <span class="badge">${cls.length}</span>
                            </div>
                            ${cls.map(c => `<div class="client-item">${c.nome} <i class="fas fa-chevron-right" onclick="UI.moveEtapa('${c.id}')"></i></div>`).join('')}
                        </div>
                    `;
                }).join('');
            },

            moveEtapa(clienteId) {
                const cliente = Core.data.clientes.find(c => c.id === clienteId);
                if(cliente.etapa === 'lead') cliente.etapa = 'visita';
                else if(cliente.etapa === 'visita') cliente.etapa = 'proposta';
                else if(cliente.etapa === 'proposta') {
                    this.preparaVenda(clienteId);
                    return;
                }
                this.saveAndUpdate();
            },

            preparaVenda(clienteId) {
                document.getElementById('venda-cliente-id').value = clienteId;
                const cliente = Core.data.clientes.find(c => c.id === clienteId);
                const imovel = Core.data.imoveis.find(i => i.id === cliente.imovelId);
                if(imovel) {
                    document.getElementById('venda-valor-real').value = Utils.formatMoney(imovel.valor);
                }
                document.getElementById('venda-data').value = new Date().toISOString().split('T')[0];
                this.openModal('venda-concluida');
            },

            async saveAndUpdate() {
                for(let c of Core.data.clientes) await DB.save("clientes", c);
                for(let i of Core.data.imoveis) await DB.save("imoveis", i);
                this.renderAll();
            }
        };

        // --- EVENTOS ---
        document.getElementById('form-imovel').onsubmit = async (e) => {
            e.preventDefault();
            const imovel = {
                id: Utils.id(),
                titulo: document.getElementById('i-titulo').value,
                valor: Utils.parseMoney(document.getElementById('i-valor').value),
                endereco: document.getElementById('i-endereco').value,
                status: document.getElementById('i-status').value,
                dataCriacao: new Date().toISOString()
            };
            await DB.save("imoveis", imovel);
            UI.closeModals();
            Core.load();
        };

        document.getElementById('form-cliente').onsubmit = async (e) => {
            e.preventDefault();
            const cliente = {
                id: Utils.id(),
                nome: document.getElementById('c-nome').value,
                tel: document.getElementById('c-tel').value,
                imovelId: document.getElementById('c-imovel').value,
                etapa: 'lead',
                dataCriacao: new Date().toISOString()
            };
            await DB.save("clientes", cliente);
            UI.closeModals();
            Core.load();
        };

        document.getElementById('form-venda-final').onsubmit = async (e) => {
            e.preventDefault();
            const cid = document.getElementById('venda-cliente-id').value;
            const valorReal = Utils.parseMoney(document.getElementById('venda-valor-real').value);
            const dataVenda = document.getElementById('venda-data').value;
            const comissaoP = Number(document.getElementById('venda-comissao-p').value);

            const cliente = Core.data.clientes.find(c => c.id === cid);
            cliente.etapa = 'venda';
            cliente.valorVendaReal = valorReal;
            cliente.dataFechamento = dataVenda;
            cliente.comissaoValor = (valorReal * comissaoP) / 100;

            const imovel = Core.data.imoveis.find(i => i.id === cliente.imovelId);
            if(imovel) imovel.status = 'vendido';

            await UI.saveAndUpdate();
            UI.closeModals();
            alert("Parab√©ns pela venda! Registrada com sucesso.");
        };

        // In√≠cio
        window.onload = async () => {
            await DB.init();
            await Core.load();
            setTimeout(() => document.getElementById('loading').style.display = 'none', 1000);
        };
    </script>
</body>
</html>
